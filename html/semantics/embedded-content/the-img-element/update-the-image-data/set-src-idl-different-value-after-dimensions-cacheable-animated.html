<!doctype html>
<title>img set .src IDL attribute to different value (after dimensions, cacheable)</title>
<script>
var rtt = 250;
if (window.performance && performance.timing && performance.timing.fetchStart) {
  rtt = new Date() - performance.timing.fetchStart;
}
</script>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/utils.js"></script>
<script src="resources/common.js"></script>
<div id=log></div>
<script>
var url_settings = {
  cached: "yes",
  animated: "no",
  delay: "after-dimensions",
  broken: "no",
};
var expected_requests = '2';
var timeline = [new Date()];
var expected_timeline_diffs = [1000, 500];

async_test(function() {
  var img = new Image();
  var url = make_url(url_settings);
  var url_put = url + 'put';
  var url_take = url + 'take';
  img.onload = this.step_func(function() {
    check_props(img, 'loaded', 'D');
    timeline.push(new Date());
    check_timeline(timeline, expected_timeline_diffs);
    img.onload = this.step_func(function() {
      check_props(img, 'loaded', 'E');
      timeline.push(new Date());
      check_timeline(timeline, expected_timeline_diffs);
      this.step(check_requests(url_take, expected_requests));
      img.onload = this.unreached_func("got third load event");
    });
  });
  img.onerror = this.unreached_func("got error event");
  img.src = url_put;
  check_props(img, 'before dimensions', 'A');
  setTimeout(this.step_func(function(){
    check_props(img, 'after dimensions', 'B');
    img.src = url_put + '&';
    check_props(img, 'after dimensions', 'C');
  }), 250 + rtt);
});
</script>
