<!DOCTYPE html>
<script src="/common/dispatcher/dispatcher.js" nonce="abc"></script>
<script src="utils.sub.js" nonce="abc"></script>
<script nonce="abc">
// For a given string `str` that is escaped by WPT's `.sub.html` or
// `pipe=sub(html)` functionality, return the original unescaped string.
//
// Concretely, for `str` as the result of `html.escape(x, quote=True)`,
// return the original unescaped string `x`.
// See `/tools/wptserve/wptserve/pipes.py` and
// https://docs.python.org/3/library/html.html#html.escape.
//
// See https://crbug.com/404573971 for fixing the escaping issue. Right now,
// the values in `requestHeaders` are still escaped.
function reverse_html_escape(str) {
  str = str.replaceAll('&lt;', '<');
  str = str.replaceAll('&gt;', '>');
  str = str.replaceAll('&quot;', '"');
  str = str.replaceAll('&#x27;', "'");
  str = str.replaceAll('&amp;', '&');
  return str;
}

window.requestHeaders = {
  purpose: "{{header_or_default(Purpose, )}}",
  sec_purpose: "{{header_or_default(Sec-Purpose, )}}",
  referer: "{{header_or_default(Referer, )}}",
  sec_fetch_dest: "{{header_or_default(Sec-Fetch-Dest, )}}",
  sec_fetch_mode: "{{header_or_default(Sec-Fetch-Mode, )}}",
  // Convert to the raw string to avoid backslashes from being processed as
  // escape sequences.
  // TODO(crbug.com/404573971): Remove `header_or_default` to reflect
  // `__no_tags__` properly.
  sec_speculation_tags: reverse_html_escape(
      String.raw`{{header_or_default(Sec-Speculation-Tags, __no_tags__)}}`),
};

// The fetch request's URL sent to the server.
window.requestUrl = reverse_html_escape(
    "{{location[server]}}{{location[path]}}{{location[query]}}");

const uuid = new URLSearchParams(location.search).get('uuid');
window.executor = new Executor(uuid);
</script>
