<!DOCTYPE html>
<html>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/speculation-rules/prerender/resources/utils.js"></script>
<body>
<script>
const params = new URLSearchParams(location.search);

// This test attempts to prerender several URLs that differ only in fragments
// like as follows:
//   - http://(snip)/fragments.html?q#fragment0
//   - http://(snip)/fragments.html?q#fragment1
//   - http://(snip)/fragments.html?q#fragment2
// After finishing prerendering, it tries to activate one URL that contains
// `fragmentActivate`
const fragments = ['#fragment0', '#fragment1', '#fragment2'];
const fragmentActivate = fragments[1];

// The main test page loads the initiator page, then the initiator page will
// prerender itself with the `prerendering` parameter.
const isPrerendering = params.has('prerendering');
if (!isPrerendering) {
  // This part is loaded as initiator page, mostly based on
  // `loadInitiatorPage()`.

  assert_true(!document.prerendering);

  const prerenderChannel = new PrerenderChannel('prerender-channel');

  // Start prerendering with fragments.
  const url = new URL(document.URL);
  url.searchParams.append('prerendering', '');
  fragments.forEach(fragment => startPrerendering(url.toString() + fragment));

  // Prepare to capture the notifications of finishing prerendering from each
  // prerendered page.
  const readyToActivates = fragments.map(fragment => {
    return new Promise((resolve) => {
      prerenderChannel.addEventListener('message', e => {
        if (e.data === 'readyToActivate' + fragment) {
          resolve(e.data);
        }
      });
    });
  });

  // Navigate the prerendered page specified by `fragmentActivate` after all
  // pages are ready to be activated.
  Promise.all(readyToActivates).then(() => {
    prerenderChannel.close();
    window.location = url.toString() + fragmentActivate;
  }).catch(e => {
    const testChannel = new PrerenderChannel('test-channel');
    testChannel.postMessage(
      `Failed to navigate the prerendered page: ${e.toString()}`);
    testChannel.postMessage('FIN');
    testChannel.close();
    prerenderChannel.close();
    window.close();
  });

} else {
  // This part is loaded as a prerendered page.

  assert_true(document.prerendering);
  const url = new URL(document.URL);

  // Inform the test page that this page is now on prerendering by sending its
  // URL fragment.
  const testChannel = new PrerenderChannel('test-channel');
  testChannel.postMessage(`prerendering ${url.hash}`);
  testChannel.close();

  // Notify the initiator page of completing prerendering by sending the
  // identifier.
  window.addEventListener('load', () => {
    const prerenderChannel = new PrerenderChannel('prerender-channel');
    prerenderChannel.postMessage('readyToActivate' + url.hash);
    prerenderChannel.close();
  });

  // Inform the test page that this page was activated by sending its URL
  // fragment.
  document.addEventListener('prerenderingchange', () => {
    const testChannel = new PrerenderChannel('test-channel');
    testChannel.postMessage(`activated ${url.hash}`);
    testChannel.postMessage('FIN');
    testChannel.close();
    window.close();
  });
}
</script>
</body>
</html>