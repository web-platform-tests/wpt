<!DOCTYPE html>
<link rel="author" href="mtrzos@google.com" title="Maciek Trzos">
<script src=/resources/testharness.js></script>
<script src=/resources/testharnessreport.js></script>
<script src=/fetch/sec-metadata/resources/helper.js></script>
<link id="style" href="https://foo.bar" rel="stylesheet">
<body></body>
<script>
  var same_origin_triggered = false;
  var same_site_triggered = false;
  var cross_site_triggered = false;

  document.addEventListener("securitypolicyviolation", (e) => {
    var css = document.getElementById("style");
    if (css != null)
      css.remove();

    if(e.originalPolicy.split("=")[1] === "report-same-origin" && !same_origin_triggered){
      same_origin_triggered = true;
      test_same_origin();
    }

    if(e.originalPolicy.split("=")[1] == "report-same-site" && !same_site_triggered){
      same_site_triggered = true;
      test_same_site();
    }

    if(e.originalPolicy.split("=")[1] == "report-cross-site" && !cross_site_triggered){
      cross_site_triggered = true;
      test_cross_site()
    }
  });

  function test_same_origin() {
    var same_origin_test = async_test("Same-Origin report");
    same_origin_test.step(function () {
        filename = "report-same-origin";
        expected_same_origin = {"destination":"report", "target":"subresource", "site":"same-origin"};

        //  Requests from the server the saved value of the Sec-Metadata header
        same_origin_xhr = new XMLHttpRequest();
        same_origin_xhr.open("GET", "/fetch/sec-metadata/resources/get-header.py?file=" + filename);

        // Async test step triggered when the response is loaded
        same_origin_xhr.onreadystatechange = same_origin_test.step_func(function () {
          verify_response(same_origin_xhr, same_origin_test, expected_same_origin)
        });
        same_origin_xhr.send();
    });
  }

  function test_same_site() {
    var same_site_test = async_test("Same-Site report");
    same_site_test.step(function () {
        filename = "report-same-site";
        expected_same_site = {"destination":"report", "target":"subresource", "site":"same-site"};

        //  Requests from the server the saved value of the Sec-Metadata header
        same_site_xhr = new XMLHttpRequest();
        same_site_xhr.open("GET", "/fetch/sec-metadata/resources/get-header.py?file=" + filename);

        // Async test step triggered when the response is loaded
        same_site_xhr.onreadystatechange = same_site_test.step_func(function () {
          verify_response(same_site_xhr, same_site_test, expected_same_site)
        });
        same_site_xhr.send();
    });
  }

  function test_cross_site() {
    var cross_site_test = async_test("Cross-Site report");
    cross_site_test.step(function () {
        filename = "report-cross-site";
        expected_cross_site = {"destination":"report", "target":"subresource", "site":"cross-site"};

        //  Requests from the server the saved value of the Sec-Metadata header
        cross_site_xhr = new XMLHttpRequest();
        cross_site_xhr.open("GET", "/fetch/sec-metadata/resources/get-header.py?file=" + filename);

        // Async test step triggered when the response is loaded
        cross_site_xhr.onreadystatechange = cross_site_test.step_func(function () {
          verify_response(cross_site_xhr, cross_site_test, expected_cross_site)
        });
        cross_site_xhr.send();
    });
  }
</script>
