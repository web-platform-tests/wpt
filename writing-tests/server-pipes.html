<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>wptserve Pipes &#8212; web-platform-tests  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Submitting Tests" href="submission-process.html" />
    <link rel="prev" title="Stash" href="../tools/wptserve/docs/stash.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="wptserve-pipes">
<h1>wptserve Pipes<a class="headerlink" href="#wptserve-pipes" title="Link to this heading">¶</a></h1>
<p>Pipes are designed to allow simple manipulation of the way that
static files are sent without requiring any custom code. They are also
useful for cross-origin tests because they can be used to activate a
substitution mechanism which can fill in details of ports and server
names in the setup on which the tests are being run.</p>
<section id="enabling">
<h2>Enabling<a class="headerlink" href="#enabling" title="Link to this heading">¶</a></h2>
<p>Pipes are functions that may be used when serving files to alter parts
of the response. These are invoked by adding a pipe= query parameter
taking a | separated list of pipe functions and parameters. The pipe
functions are applied to the response from left to right. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GET /sample.txt?pipe=slice(1,200)|status(404).
</pre></div>
</div>
<p>This would serve bytes 1 to 199, inclusive, of foo.txt with the HTTP status
code 404.</p>
<p>Note: If you write directly to the response socket using ResponseWriter, or
when using the asis handler, only the trickle pipe will affect the response.</p>
<p>There are several built-in pipe functions, and it is possible to add
more using the <code class="docutils literal notranslate"><span class="pre">&#64;pipe</span></code> decorator on a function, if required.</p>
<p>Note: Because of the way pipes compose, using some pipe functions prevents the
content-length of the response from being known in advance. In these cases the
server will close the connection to indicate the end of the response,
preventing the use of HTTP 1.1 keepalive.</p>
</section>
<section id="built-in-pipes">
<h2>Built-In Pipes<a class="headerlink" href="#built-in-pipes" title="Link to this heading">¶</a></h2>
<section id="sub">
<h3><code class="docutils literal notranslate"><span class="pre">sub</span></code><a class="headerlink" href="#sub" title="Link to this heading">¶</a></h3>
<p>Used to substitute variables from the server environment, or from the
request into the response. A typical use case is for testing
cross-domain since the exact domain name and ports of the servers are
generally unknown.</p>
<p>Substitutions are marked in a file using a block delimited by <code class="docutils literal notranslate"><span class="pre">{{</span></code>
and <code class="docutils literal notranslate"><span class="pre">}}</span></code>. Inside the block the following variables are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{{host}}</span></code> - The host name of the server excluding any subdomain part.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{{domains[]}}</span></code> - The domain name of a particular subdomain e.g.
<code class="docutils literal notranslate"><span class="pre">{{domains[www]}}</span></code> for the <code class="docutils literal notranslate"><span class="pre">www</span></code> subdomain.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{{hosts[][]}}</span></code> - The domain name of a particular subdomain for a particular
host. The first key may be empty (designating the “default” host) or the
value <code class="docutils literal notranslate"><span class="pre">alt</span></code>; i.e., <code class="docutils literal notranslate"><span class="pre">{{hosts[alt][]}}</span></code> (designating the alternate host).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{{ports[][]}}</span></code> - The port number of servers, by protocol e.g.
<code class="docutils literal notranslate"><span class="pre">{{ports[http][0]}}</span></code> for the first (and, depending on setup, possibly only)
http server</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{{headers[]}}</span></code> The HTTP headers in the request e.g. <code class="docutils literal notranslate"><span class="pre">{{headers[X-Test]}}</span></code>
for a hypothetical <code class="docutils literal notranslate"><span class="pre">X-Test</span></code> header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{{header_or_default(header,</span> <span class="pre">default)}}</span></code> The value of an HTTP header, or a
default value if it is absent. e.g. <code class="docutils literal notranslate"><span class="pre">{{header_or_default(X-Test,</span> <span class="pre">test-header-absent)}}</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{{GET[]}}</span></code> The query parameters for the request e.g. <code class="docutils literal notranslate"><span class="pre">{{GET[id]}}</span></code> for an id
parameter sent with the request.</p></li>
</ul>
<p>So, for example, to write a JavaScript file called <code class="docutils literal notranslate"><span class="pre">xhr.js</span></code> that
depends on the host name of the server, without hardcoding, one might
write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">server_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">{{</span><span class="n">host</span><span class="p">}}:{{</span><span class="n">ports</span><span class="p">[</span><span class="n">http</span><span class="p">][</span><span class="mi">0</span><span class="p">]}}</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">resource</span><span class="p">;</span>
<span class="o">//</span><span class="n">Create</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">XHR</span> <span class="ow">and</span> <span class="n">so</span> <span class="n">on</span>
</pre></div>
</div>
<p>The file would then be included as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;xhr.js?pipe=sub&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This pipe can also be enabled by using a filename <code class="docutils literal notranslate"><span class="pre">*.sub.ext</span></code>, e.g. the file above could be called <code class="docutils literal notranslate"><span class="pre">xhr.sub.js</span></code>.</p>
</section>
<section id="status">
<h3><code class="docutils literal notranslate"><span class="pre">status</span></code><a class="headerlink" href="#status" title="Link to this heading">¶</a></h3>
<p>Used to set the HTTP status of the response, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.js?pipe=status(410)
</pre></div>
</div>
</section>
<section id="headers">
<h3><code class="docutils literal notranslate"><span class="pre">headers</span></code><a class="headerlink" href="#headers" title="Link to this heading">¶</a></h3>
<p>Used to add or replace http headers in the response. Takes two or
three arguments; the header name, the header value and whether to
append the header rather than replace an existing header (default:
False). So, for example, a request for:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.html?pipe=header(Content-Type,text/plain)
</pre></div>
</div>
<p>causes example.html to be returned with a text/plain content type
whereas:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.html?pipe=header(Content-Type,text/plain,True)
</pre></div>
</div>
<p>Will cause example.html to be returned with both text/html and
text/plain content-type headers.</p>
<p>If the comma (<code class="docutils literal notranslate"><span class="pre">,</span></code>) or closing parenthesis (<code class="docutils literal notranslate"><span class="pre">)</span></code>) characters appear in the header
value, those characters  must be escaped with a backslash (<code class="docutils literal notranslate"><span class="pre">\</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example?pipe=header(Expires,Thu\,%2014%20Aug%201986%2018:00:00%20GMT)
</pre></div>
</div>
<p>(Note that the programming environment from which the request is issued may
require that the backslash character itself be escaped.)</p>
</section>
<section id="slice">
<h3><code class="docutils literal notranslate"><span class="pre">slice</span></code><a class="headerlink" href="#slice" title="Link to this heading">¶</a></h3>
<p>Used to send only part of a response body. Takes the start and,
optionally, end bytes as arguments, although either can be null to
indicate the start or end of the file, respectively. So for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=slice(10,20)
</pre></div>
</div>
<p>Would result in a response with a body containing 10 bytes of
example.txt including byte 10 but excluding byte 20.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=slice(10)
</pre></div>
</div>
<p>Would cause all bytes from byte 10 of example.txt to be sent, but:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=slice(null,20)
</pre></div>
</div>
<p>Would send the first 20 bytes of example.txt.</p>
</section>
<section id="trickle">
<h3><code class="docutils literal notranslate"><span class="pre">trickle</span></code><a class="headerlink" href="#trickle" title="Link to this heading">¶</a></h3>
<p>Note: Using this function will force a connection close.</p>
<p>Used to send the body of a response in chunks with delays. Takes a
single argument that is a microsyntax consisting of colon-separated
commands. There are three types of commands:</p>
<ul class="simple">
<li><p>Bare numbers represent a number of bytes to send</p></li>
<li><p>Numbers prefixed <code class="docutils literal notranslate"><span class="pre">d</span></code> indicate a delay in seconds</p></li>
<li><p>Numbers prefixed <code class="docutils literal notranslate"><span class="pre">r</span></code> must only appear at the end of the command, and
indicate that the preceding N items must be repeated until there is
no more content to send. The number of items to repeat must be even.</p></li>
</ul>
<p>In the absence of a repetition command, the entire remainder of the content is
sent at once when the command list is exhausted. So for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=trickle(d1)
</pre></div>
</div>
<p>causes a 1s delay before sending the entirety of example.txt.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=trickle(100:d1)
</pre></div>
</div>
<p>causes 100 bytes of example.txt to be sent, followed by a 1s delay,
and then the remainder of the file to be sent. On the other hand:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=trickle(100:d1:r2)
</pre></div>
</div>
<p>Will cause the file to be sent in 100 byte chunks separated by a 1s
delay until the whole content has been sent.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">web-platform-tests</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../test-suite-design.html">Test Suite Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro-video-transcript.html">“Introduction to WPT” video transcript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running-tests/index.html">Running Tests</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Writing Tests</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#test-types">Test Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#submitting-tests">Submitting Tests</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#table-of-contents">Table of Contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reviewing-tests/index.html">Reviewing Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin/index.html">Project Administration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Writing Tests</a><ul>
  <li><a href="server-features.html">Server Features</a><ul>
      <li>Previous: <a href="../tools/wptserve/docs/stash.html" title="previous chapter">Stash</a></li>
      <li>Next: <a href="submission-process.html" title="next chapter">Submitting Tests</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, wpt contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/writing-tests/server-pipes.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>