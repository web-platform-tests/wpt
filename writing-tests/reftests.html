
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Reftests &#8212; web-platform-tests  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing a reftest" href="reftest-tutorial.html" />
    <link rel="prev" title="Rendering Test Guidelines" href="rendering.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="reftests">
<h1>Reftests<a class="headerlink" href="#reftests" title="Permalink to this headline">¶</a></h1>
<p>Reftests are one of the primary tools for testing things relating to
rendering; they are made up of the test and one or more other pages
(”references”) with assertions as to whether they render identically
or not. This page describes their aspects exhaustively; <a class="reference internal" href="reftest-tutorial.html"><span class="doc">the tutorial
on writing a reftest</span></a> offers a more limited but
grounded guide to the process.</p>
<section id="how-to-run-reftests">
<h2>How to Run Reftests<a class="headerlink" href="#how-to-run-reftests" title="Permalink to this headline">¶</a></h2>
<p>Reftests can be run manually simply by opening the test and the
reference file in multiple windows or tabs and flipping between the
two. In automation the comparison is done in an automated fashion,
which can lead to differences hard for the human eye to notice to
cause the test to fail.</p>
</section>
<section id="components-of-a-reftest">
<h2>Components of a Reftest<a class="headerlink" href="#components-of-a-reftest" title="Permalink to this headline">¶</a></h2>
<p>In the simplest case, a reftest consists of a pair of files called the
<em>test</em> and the <em>reference</em>.</p>
<p>The <em>test</em> file is the one that makes use of the technology being
tested. It also contains a <code class="docutils literal notranslate"><span class="pre">link</span></code> element with <code class="docutils literal notranslate"><span class="pre">rel=&quot;match&quot;</span></code> or
<code class="docutils literal notranslate"><span class="pre">rel=&quot;mismatch&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">href</span></code> attribute pointing to the <em>reference</em>
file, e.g. <code class="docutils literal notranslate"><span class="pre">&lt;link</span> <span class="pre">rel=match</span> <span class="pre">href=references/green-box-ref.html&gt;</span></code>. A
<code class="docutils literal notranslate"><span class="pre">match</span></code> test only passes if the two files render pixel-for-pixel
identically within a 800x600 window <em>including</em> scroll-bars if
present; a <code class="docutils literal notranslate"><span class="pre">mismatch</span></code> test only passes if they <em>don’t</em> render
identically.</p>
<p>The <em>reference</em> file is typically written to be as simple as possible,
and does not use the technology under test. It is desirable that the
reference be rendered correctly even in UAs with relatively poor
support for CSS and no support for the technology under test.</p>
</section>
<section id="writing-a-good-reftest">
<h2>Writing a Good Reftest<a class="headerlink" href="#writing-a-good-reftest" title="Permalink to this headline">¶</a></h2>
<p>In general the files used in a reftest should follow
the <a class="reference internal" href="general-guidelines.html"><span class="doc">general guidelines</span></a> and
the <a class="reference internal" href="rendering.html"><span class="doc">rendering test guidelines</span></a>. They should also be
self-describing, to allow a human to determine whether the the
rendering is as expected.</p>
<p>References can be shared between tests; this is strongly encouraged as
it makes it easier to tell at a glance whether a test passes (through
familiarity) and enables some optimizations in automated test
runners. Shared references are typically placed in <code class="docutils literal notranslate"><span class="pre">references</span></code>
directories, either alongside the tests they are expected to be useful
for or at the top level if expected to be generally applicable (e.g.,
many layout tests can be written such that the correct rendering is a
100x100 green square!). For references that are applicable only to a
single test, it is recommended to use the test name with a suffix of
<code class="docutils literal notranslate"><span class="pre">-ref</span></code> as their filename; e.g., <code class="docutils literal notranslate"><span class="pre">test.html</span></code> would have <code class="docutils literal notranslate"><span class="pre">test-ref.html</span></code>
as a reference.</p>
</section>
<section id="multiple-references">
<h2>Multiple References<a class="headerlink" href="#multiple-references" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, a test’s pass condition cannot be captured in a single
reference.</p>
<p>If a test has multiple links, then the test passes if:</p>
<ul class="simple">
<li><p>If there are any match references, at least one must match, and</p></li>
<li><p>If there are any mismatch references, all must mismatch.</p></li>
</ul>
<p>If you need multiple matches to succeed, these can be turned into
multiple tests (for example, by just having a reference be a test
itself!). If this seems like an unreasonable restriction, please file
a bug and let us know!</p>
</section>
<section id="controlling-when-comparison-occurs">
<h2>Controlling When Comparison Occurs<a class="headerlink" href="#controlling-when-comparison-occurs" title="Permalink to this headline">¶</a></h2>
<p>By default, reftest screenshots are taken after the following
conditions are met:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">load</span></code> event has fired</p></li>
<li><p>Web fonts (if any) are loaded</p></li>
<li><p>Pending paints have completed</p></li>
</ul>
<p>In some cases it is necessary to delay the screenshot later than this,
for example because some DOM manipulation is required to set up the
desired test conditions. To enable this, the test may have a
<code class="docutils literal notranslate"><span class="pre">class=&quot;reftest-wait&quot;</span></code> attribute specified on the root element. In
this case the harness will run the following sequence of steps:</p>
<ul class="simple">
<li><p>Wait for the <code class="docutils literal notranslate"><span class="pre">load</span></code> event to fire and fonts to load.</p></li>
<li><p>Wait for pending paints to complete.</p></li>
<li><p>Fire an event named <code class="docutils literal notranslate"><span class="pre">TestRendered</span></code> at the root element, with the
<code class="docutils literal notranslate"><span class="pre">bubbles</span></code> attribute set to true.</p></li>
<li><p>Wait for the <code class="docutils literal notranslate"><span class="pre">reftest-wait</span></code> class to be removed from the root
element.</p></li>
<li><p>Wait for pending paints to complete.</p></li>
<li><p>Screenshot the viewport.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">TestRendered</span></code> event provides a hook for tests to make
modifications to the test document that are not batched into the
initial layout/paint.</p>
</section>
<section id="fuzzy-matching">
<h2>Fuzzy Matching<a class="headerlink" href="#fuzzy-matching" title="Permalink to this headline">¶</a></h2>
<p>In some situations a test may have subtle differences in rendering
compared to the reference due to, e.g., anti-aliasing. To allow for
these small differences, we allow tests to specify a fuzziness
characterised by two parameters, both of which must be specified:</p>
<ul class="simple">
<li><p>A maximum difference in the per-channel color value for any pixel.</p></li>
<li><p>A number of total pixels that may be different.</p></li>
</ul>
<p>The maximum difference in the per pixel color value is formally
defined as follows: let <code>T<sub>x,y,c</sub></code> be the value of
colour channel <code class="docutils literal notranslate"><span class="pre">c</span></code> at pixel coordinates <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code> in the test image and
<code>R<sub>x,y,c</sub></code> be the corresponding value in the
reference image, and let <code>width</code> and <code>height</code> be
the dimensions of the image in pixels. Then <code>maxDifference =
max<sub>x=[0,width) y=[0,height), c={r,g,b}</sub>(|T<sub>x,y,c</sub> -
R<sub>x,y,c</sub>|)</code>.</p>
<p>To specify the fuzziness in the test file one may add a <code class="docutils literal notranslate"><span class="pre">&lt;meta</span> <span class="pre">name=fuzzy&gt;</span></code> element (or, in the case of more complex tests, to any
page containing the <code class="docutils literal notranslate"><span class="pre">&lt;link</span> <span class="pre">rel=[mis]match&gt;</span></code> elements). In the simplest
case this has a <code class="docutils literal notranslate"><span class="pre">content</span></code> attribute containing the parameters above,
separated by a semicolon e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="n">fuzzy</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;maxDifference=15;totalPixels=300&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>would allow for a  difference of exactly 15 / 255 on any color channel
and 300 exactly pixels total difference. The argument names are optional
and may be elided; the above is the same as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="n">fuzzy</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;15;300&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The values may also be given as ranges e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="n">fuzzy</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;maxDifference=10-15;totalPixels=200-300&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="n">fuzzy</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;10-15;200-300&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>In this case the maximum pixel difference must be in the range
<code class="docutils literal notranslate"><span class="pre">10-15</span></code> and the total number of different pixels must be in the range
<code class="docutils literal notranslate"><span class="pre">200-300</span></code>. These range checks are inclusive.</p>
<p>In cases where a single test has multiple possible refs and the
fuzziness is not the same for all refs, a ref may be specified by
prefixing the <code class="docutils literal notranslate"><span class="pre">content</span></code> value with the relative url for the ref e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="n">fuzzy</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;option1-ref.html:10-15;200-300&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>One meta element is required per reference requiring a unique
fuzziness value, but any unprefixed value will automatically be
applied to any ref that doesn’t have a more specific value.</p>
<section id="debugging-fuzzy-reftests">
<h3>Debugging fuzzy reftests<a class="headerlink" href="#debugging-fuzzy-reftests" title="Permalink to this headline">¶</a></h3>
<p>When debugging a fuzzy reftest via <code class="docutils literal notranslate"><span class="pre">wpt</span> <span class="pre">run</span></code>, it can be useful to know what the
allowed and detected differences were. Many of the output logger options will
provide this information. For example, by passing <code class="docutils literal notranslate"><span class="pre">--log-mach=-</span></code> for a run of a
hypothetical failing test, one might get:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span><span class="p">:</span><span class="mf">08.15</span> <span class="n">TEST_START</span><span class="p">:</span> <span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">bar</span><span class="o">.</span><span class="n">html</span>
 <span class="mi">0</span><span class="p">:</span><span class="mf">09.70</span> <span class="n">INFO</span> <span class="n">Found</span> <span class="mi">250</span> <span class="n">pixels</span> <span class="n">different</span><span class="p">,</span> <span class="n">maximum</span> <span class="n">difference</span> <span class="n">per</span> <span class="n">channel</span> <span class="mi">6</span> <span class="n">on</span> <span class="n">page</span> <span class="mi">1</span>
 <span class="mi">0</span><span class="p">:</span><span class="mf">09.70</span> <span class="n">INFO</span> <span class="n">Allowed</span> <span class="mi">0</span><span class="o">-</span><span class="mi">100</span> <span class="n">pixels</span> <span class="n">different</span><span class="p">,</span> <span class="n">maximum</span> <span class="n">difference</span> <span class="n">per</span> <span class="n">channel</span> <span class="mi">0</span><span class="o">-</span><span class="mi">0</span>
 <span class="mi">0</span><span class="p">:</span><span class="mf">09.70</span> <span class="n">TEST_END</span><span class="p">:</span> <span class="n">FAIL</span><span class="p">,</span> <span class="n">expected</span> <span class="n">PASS</span> <span class="o">-</span> <span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">bar</span><span class="o">.</span><span class="n">html</span> <span class="p">[</span><span class="s1">&#39;f83385ed9c9bea168108b8c448366678c7941627&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>For other logging flags, see the output of <code class="docutils literal notranslate"><span class="pre">wpt</span> <span class="pre">run</span> <span class="pre">--help</span></code>.</p>
</section>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>In some cases, a test cannot be a reftest. For example, there is no
way to create a reference for underlining, since the position and
thickness of the underline depends on the UA, the font, and/or the
platform. However, once it’s established that underlining an inline
element works, it’s possible to construct a reftest for underlining
a block element, by constructing a reference using underlines on a
<code class="docutils literal notranslate"><span class="pre">&lt;span&gt;</span></code> that wraps all the content inside the block.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">web-platform-tests</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../test-suite-design.html">Test Suite Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro-video-transcript.html">“Introduction to WPT” video transcript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running-tests/index.html">Running Tests</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Writing Tests</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#test-types">Test Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#submitting-tests">Submitting Tests</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#table-of-contents">Table of Contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reviewing-tests/index.html">Reviewing Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin/index.html">Project Administration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Writing Tests</a><ul>
      <li>Previous: <a href="rendering.html" title="previous chapter">Rendering Test Guidelines</a></li>
      <li>Next: <a href="reftest-tutorial.html" title="next chapter">Writing a reftest</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, wpt contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/writing-tests/reftests.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>