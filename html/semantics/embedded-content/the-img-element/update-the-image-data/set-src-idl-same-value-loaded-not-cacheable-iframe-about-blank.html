<!doctype html>
<title>img set .src IDL attribute to same value (loaded, not cacheable) in iframe, about:blank</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/utils.js"></script>
<script src="resources/common.js"></script>
<div id=log></div>
<script>
var url_settings = {
  cached: "no",
  animated: "no",
  delay: "no",
  broken: "no",
};
var expected_requests = '2';
var expected_props = {
  width: 1,
  height: 1,
  complete: true,
};

async_test(function() {
  var img = new Image();
  var url = make_url(url_settings);
  var url_put = url + 'put';
  var url_take = url + 'take';
  img.onload = this.step_func(function() {
    check_props(img, expected_props);
    img.onload = this.unreached_func("got second load event");
    var iframe = document.createElement('iframe');
    document.body.appendChild(iframe);
    // setTimeout shouldn't be necessary but Gecko failed to fire load on img
    // without it and Blink doesn't fire load on iframe here so...
    setTimeout(this.step_func(function() {
      var doc = iframe.contentDocument;
      var img2 = doc.createElement('img');
      img2.onload = this.step_func(function() {
        check_props(img2, expected_props);
        this.step(check_requests(url_take, expected_requests));
        img2.onload = this.unreached_func("got second load event in iframe");
      });
      img2.onerror = this.unreached_func("got error event in iframe")
      doc.body.appendChild(img2);
      img2.src = url_put;
    }), 0);
  });
  img.onerror = this.unreached_func("got error event");
  img.src = url_put;
});
</script>
