
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wptserve Pipes &#8212; web-platform-tests  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Submitting Tests" href="submission-process.html" />
    <link rel="prev" title="Stash" href="../tools/wptserve/docs/stash.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="wptserve-pipes">
<h1>wptserve Pipes<a class="headerlink" href="#wptserve-pipes" title="Permalink to this headline">¶</a></h1>
<p>Pipes are designed to allow simple manipulation of the way that
static files are sent without requiring any custom code. They are also
useful for cross-origin tests because they can be used to activate a
substitution mechanism which can fill in details of ports and server
names in the setup on which the tests are being run.</p>
<div class="section" id="enabling">
<h2>Enabling<a class="headerlink" href="#enabling" title="Permalink to this headline">¶</a></h2>
<p>Pipes are functions that may be used when serving files to alter parts
of the response. These are invoked by adding a pipe= query parameter
taking a | separated list of pipe functions and parameters. The pipe
functions are applied to the response from left to right. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>GET /sample.txt?pipe=slice(1,200)|status(404).
</pre></div>
</div>
<p>This would serve bytes 1 to 199, inclusive, of foo.txt with the HTTP status
code 404.</p>
<p>Note: If you write directly to the response socket using ResponseWriter, or
when using the asis handler, only the trickle pipe will affect the response.</p>
<p>There are several built-in pipe functions, and it is possible to add
more using the <code class="docutils literal notranslate"><span class="pre">&#64;pipe</span></code> decorator on a function, if required.</p>
<p>Note: Because of the way pipes compose, using some pipe functions prevents the
content-length of the response from being known in advance. In these cases the
server will close the connection to indicate the end of the response,
preventing the use of HTTP 1.1 keepalive.</p>
</div>
<div class="section" id="built-in-pipes">
<h2>Built-In Pipes<a class="headerlink" href="#built-in-pipes" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sub">
<h3><code class="docutils literal notranslate"><span class="pre">sub</span></code><a class="headerlink" href="#sub" title="Permalink to this headline">¶</a></h3>
<p>Used to substitute variables from the server environment, or from the
request into the response. A typical use case is for testing
cross-domain since the exact domain name and ports of the servers are
generally unknown.</p>
<p>Substitutions are marked in a file using a block delimited by <code class="docutils literal notranslate"><span class="pre">{{</span></code>
and <code class="docutils literal notranslate"><span class="pre">}}</span></code>. Inside the block the following variables are available:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">{{host}}</span></code> - The host name of the server excluding any subdomain part.</li>
<li><code class="docutils literal notranslate"><span class="pre">{{domains[]}}</span></code> - The domain name of a particular subdomain e.g.
<code class="docutils literal notranslate"><span class="pre">{{domains[www]}}</span></code> for the <code class="docutils literal notranslate"><span class="pre">www</span></code> subdomain.</li>
<li><code class="docutils literal notranslate"><span class="pre">{{ports[][]}}</span></code> - The port number of servers, by protocol e.g.
<code class="docutils literal notranslate"><span class="pre">{{ports[http][0]}}</span></code> for the first (and, depending on setup, possibly only)
http server</li>
<li><code class="docutils literal notranslate"><span class="pre">{{headers[]}}</span></code> The HTTP headers in the request e.g. <code class="docutils literal notranslate"><span class="pre">{{headers[X-Test]}}</span></code>
for a hypothetical <code class="docutils literal notranslate"><span class="pre">X-Test</span></code> header.</li>
<li><code class="docutils literal notranslate"><span class="pre">{{header_or_default(header,</span> <span class="pre">default)}}</span></code> The value of an HTTP header, or a
default value if it is absent. e.g. <code class="docutils literal notranslate"><span class="pre">{{header_or_default(X-Test,</span> <span class="pre">test-header-absent)}}</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">{{GET[]}}</span></code> The query parameters for the request e.g. <code class="docutils literal notranslate"><span class="pre">{{GET[id]}}</span></code> for an id
parameter sent with the request.</li>
</ul>
<p>So, for example, to write a JavaScript file called <code class="docutils literal notranslate"><span class="pre">xhr.js</span></code> that
depends on the host name of the server, without hardcoding, one might
write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">server_url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">{{</span><span class="n">host</span><span class="p">}}:{{</span><span class="n">ports</span><span class="p">[</span><span class="n">http</span><span class="p">][</span><span class="mi">0</span><span class="p">]}}</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">resource</span><span class="p">;</span>
<span class="o">//</span><span class="n">Create</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">XHR</span> <span class="ow">and</span> <span class="n">so</span> <span class="n">on</span>
</pre></div>
</div>
<p>The file would then be included as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;xhr.js?pipe=sub&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This pipe can also be enabled by using a filename <code class="docutils literal notranslate"><span class="pre">*.sub.ext</span></code>, e.g. the file above could be called <code class="docutils literal notranslate"><span class="pre">xhr.sub.js</span></code>.</p>
</div>
<div class="section" id="status">
<h3><code class="docutils literal notranslate"><span class="pre">status</span></code><a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h3>
<p>Used to set the HTTP status of the response, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.js?pipe=status(410)
</pre></div>
</div>
</div>
<div class="section" id="headers">
<h3><code class="docutils literal notranslate"><span class="pre">headers</span></code><a class="headerlink" href="#headers" title="Permalink to this headline">¶</a></h3>
<p>Used to add or replace http headers in the response. Takes two or
three arguments; the header name, the header value and whether to
append the header rather than replace an existing header (default:
False). So, for example, a request for:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.html?pipe=header(Content-Type,text/plain)
</pre></div>
</div>
<p>causes example.html to be returned with a text/plain content type
whereas:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.html?pipe=header(Content-Type,text/plain,True)
</pre></div>
</div>
<p>Will cause example.html to be returned with both text/html and
text/plain content-type headers.</p>
</div>
<div class="section" id="slice">
<h3><code class="docutils literal notranslate"><span class="pre">slice</span></code><a class="headerlink" href="#slice" title="Permalink to this headline">¶</a></h3>
<p>Used to send only part of a response body. Takes the start and,
optionally, end bytes as arguments, although either can be null to
indicate the start or end of the file, respectively. So for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=slice(10,20)
</pre></div>
</div>
<p>Would result in a response with a body containing 10 bytes of
example.txt including byte 10 but excluding byte 20.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=slice(10)
</pre></div>
</div>
<p>Would cause all bytes from byte 10 of example.txt to be sent, but:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=slice(null,20)
</pre></div>
</div>
<p>Would send the first 20 bytes of example.txt.</p>
</div>
<div class="section" id="trickle">
<h3><code class="docutils literal notranslate"><span class="pre">trickle</span></code><a class="headerlink" href="#trickle" title="Permalink to this headline">¶</a></h3>
<p>Note: Using this function will force a connection close.</p>
<p>Used to send the body of a response in chunks with delays. Takes a
single argument that is a microsyntax consisting of colon-separated
commands. There are three types of commands:</p>
<ul class="simple">
<li>Bare numbers represent a number of bytes to send</li>
<li>Numbers prefixed <code class="docutils literal notranslate"><span class="pre">d</span></code> indicate a delay in seconds</li>
<li>Numbers prefixed <code class="docutils literal notranslate"><span class="pre">r</span></code> must only appear at the end of the command, and
indicate that the preceding N items must be repeated until there is
no more content to send. The number of items to repeat must be even.</li>
</ul>
<p>In the absence of a repetition command, the entire remainder of the content is
sent at once when the command list is exhausted. So for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=trickle(d1)
</pre></div>
</div>
<p>causes a 1s delay before sending the entirety of example.txt.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=trickle(100:d1)
</pre></div>
</div>
<p>causes 100 bytes of example.txt to be sent, followed by a 1s delay,
and then the remainder of the file to be sent. On the other hand:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>example.txt?pipe=trickle(100:d1:r2)
</pre></div>
</div>
<p>Will cause the file to be sent in 100 byte chunks separated by a 1s
delay until the whole content has been sent.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">web-platform-tests</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../test-suite-design.html">Test Suite Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running-tests/index.html">Running Tests</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Writing Tests</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="general-guidelines.html">General Test Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="ahem.html">The Ahem Font</a></li>
<li class="toctree-l2"><a class="reference internal" href="assumptions.html">Test Assumptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="css-metadata.html">CSS Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="css-user-styles.html">CSS User Stylesheets</a></li>
<li class="toctree-l2"><a class="reference internal" href="file-names.html">File Name Flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="h2tests.html">Writing H2 Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="lint-tool.html">Lint Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="making-a-testing-plan.html">Making a Testing Plan</a></li>
<li class="toctree-l2"><a class="reference internal" href="manual.html">Manual Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="reftest-tutorial.html">Writing a reftest</a></li>
<li class="toctree-l2"><a class="reference internal" href="reftests.html">Reftests</a></li>
<li class="toctree-l2"><a class="reference internal" href="rendering.html">Rendering Test Guidelines</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="server-features.html">Server Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="submission-process.html">Submitting Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="testdriver.html">testdriver.js Automation</a></li>
<li class="toctree-l2"><a class="reference internal" href="testdriver-extension-tutorial.html">Testdriver extension tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="testharness.html">testharness.js Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="testharness-tutorial.html">testharness.js tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html">Command-line utility scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="visual.html">Visual Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="wdspec.html">wdspec tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="test-templates.html">Test Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="github-intro.html">Introduction to GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#test-type">Test Type</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#submitting-tests">Submitting Tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reviewing-tests/index.html">Reviewing Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin/index.html">Project Administration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Writing Tests</a><ul>
  <li><a href="server-features.html">Server Features</a><ul>
      <li>Previous: <a href="../tools/wptserve/docs/stash.html" title="previous chapter">Stash</a></li>
      <li>Next: <a href="submission-process.html" title="next chapter">Submitting Tests</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, wpt contributors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/writing-tests/server-pipes.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>