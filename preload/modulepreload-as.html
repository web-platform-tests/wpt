<!doctype html>
<meta charset=utf-8>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
  // Compared to modulepreload.html, this tests behavior when elements are
  // initially on an HTML page instead of being added by Javascript.
  const scriptLikes = [
    'audioworklet',
    'paintworklet',
    'script',
    'serviceworker',
    'sharedworker',
    'worker',
  ];

  const goodAsValues = ['', 'invalid-dest', 'sCrIpT', 'style', 'json', ...scriptLikes];
  const linkPromises = {};

  function handleLoad(target) {
    const asValue = target.dataset.as;
    if (!linkPromises[asValue]) {
      linkPromises[asValue] = {};
      linkPromises[asValue].promise = new Promise((resolve) => {
        linkPromises[asValue].resolve = resolve;
      });
    }
    linkPromises[asValue].resolve({ target, eventType: 'load' });
  }

  function handleError(target) {
    const asValue = target.dataset.as;
    if (!linkPromises[asValue]) {
      linkPromises[asValue] = {};
      linkPromises[asValue].promise = new Promise((resolve) => {
        linkPromises[asValue].resolve = resolve;
      });
    }
    linkPromises[asValue].resolve({ target, eventType: 'error' });
  }
</script>
<link rel="modulepreload" href="resources/module1.js?empty-string" as="" data-as="" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?audio" as="audio" data-as="audio" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?audioworklet" as="audioworklet" data-as="audioworklet" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?document" as="document" data-as="document" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?embed" as="embed" data-as="embed" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?font" as="font" data-as="font" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?frame" as="frame" data-as="frame" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?iframe" as="iframe" data-as="iframe" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?image" as="image" data-as="image" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?manifest" as="manifest" data-as="manifest" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?object" as="object" data-as="object" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?paintworklet" as="paintworklet" data-as="paintworklet" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?report" as="report" data-as="report" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?script" as="script" data-as="script" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?serviceworker" as="serviceworker" data-as="serviceworker" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?sharedworker" as="sharedworker" data-as="sharedworker" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?track" as="track" data-as="track" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?video" as="video" data-as="video" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?webidentity" as="webidentity" data-as="webidentity" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?worker" as="worker" data-as="worker" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?xslt" as="xslt" data-as="xslt" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?fetch" as="fetch" data-as="fetch" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?invalid-dest" as="invalid-dest" data-as="invalid-dest" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?iMaGe" as="iMaGe" data-as="iMaGe" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/module1.js?sCrIpT" as="sCrIpT" data-as="sCrIpT" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/dummy.css?style" as="style" data-as="style" onload="handleLoad(this)" onerror="handleError(this)">
<link rel="modulepreload" href="resources/dummy.json?json" as="json" data-as="json" onload="handleLoad(this)" onerror="handleError(this)">
<script>
  const links = document.querySelectorAll('link[rel="modulepreload"]');
  for (const link of links) {
    const asValue = link.dataset.as;

    // Ensure promise exists (in case the event hasn't fired yet).
    if (!linkPromises[asValue]) {
      linkPromises[asValue] = {};
      linkPromises[asValue].promise = new Promise((resolve) => {
        linkPromises[asValue].resolve = resolve;
      });
    }

    const shouldSucceed = goodAsValues.includes(asValue);
    const description = shouldSucceed
      ? `Modulepreload should fire onload with as="${asValue}"`
      : `Modulepreload should fire onerror with as="${asValue}"`;

    promise_test(async t => {
      const { eventType } = await linkPromises[asValue].promise;

      if (shouldSucceed) {
        assert_equals(eventType, 'load', 'Expected onload to fire');
      } else {
        assert_equals(eventType, 'error', 'Expected onerror to fire');
      }
    }, description);
  }
</script>
<body>
