<!DOCTYPE html>
<meta name="timeout" content="long">
<meta name="variant" content="?origin=same-origin">
<meta name="variant" content="?origin=cross-site-redirect">
<meta name="variant" content="?origin=cross-site-initial">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/dispatcher/dispatcher.js"></script>
<script src="/common/utils.js"></script>
<script src="../resources/utils.js"></script>
<script src="resources/utils.sub.js"></script>
<script src="resources/redirect-helper.sub.js"></script>
<script src="/resources/testdriver.js?feature=bidi"></script>
<script src="/resources/testdriver-extra.js"></script>

<script>
setup(() => assertSpeculationRulesIsSupported());
// Navigate to the initial URL of the prefetch.
for (const prefetchTiming of
    ['redirect-received-before-navigation-start',
     'redirect-received-after-navigation-start']) {
  promise_test(async t => {
    // Subscribe to the BiDi prefetch_status_updated event and set up a promise to await it.
    await test_driver.bidi.speculation.prefetch_status_updated.subscribe();
    let prefetchStatusPromise = new Promise(resolve => {
      test_driver.bidi.speculation.prefetch_status_updated.on(event => {
        if (event && event.status !== undefined) resolve(event.status);
      });
    });

    const {agent,
           prefetchInitialUrl,
           prefetchFinalUrl,
           redirectToPrefetchInitialUrl,
           redirectToPrefetchFinalUrl} = await prepare(t, prefetchTiming);

    await agent.forceSinglePrefetch(prefetchInitialUrl);
    await agent.navigate(prefetchInitialUrl,
                         {expectedDestinationUrl: prefetchFinalUrl});

    // Wait for the BiDi prefetch_status_updated event before assertions
    await prefetchStatusPromise;

    assert_prefetched(await agent.getRequestHeaders(),
        'Prefetched response should be used by navigation.');
  }, prefetchTiming);
}
</script>
